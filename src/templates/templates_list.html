{% extends "base.html" %}

{% block title %}模板管理 - VMA{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">模板管理</h1>
      <p class="text-sm text-gray-600 mt-1">选择模板后可进行操作</p>
    </div>
    <a href="/templates/new" class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 transition-colors">新建模板</a>
  </div>

  <!-- 操作按钮栏 -->
  <div class="flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
    <span class="text-sm text-gray-600 font-medium">操作：</span>
    <button id="viewBtn" disabled class="inline-flex items-center px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
      查看
    </button>
    <button id="editBtn" disabled class="inline-flex items-center px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
      编辑
    </button>
    <button id="deleteBtn" disabled class="inline-flex items-center px-4 py-2 rounded-lg border border-red-300 text-sm font-medium text-red-600 bg-white hover:bg-red-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
      删除
    </button>
    <button id="copyBtn" disabled class="inline-flex items-center px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
      复制
    </button>
    <button id="executeBtn" disabled class="inline-flex items-center px-4 py-2 rounded-lg border border-green-500 text-sm font-medium text-green-600 bg-white hover:bg-green-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      创建任务
    </button>
  </div>

  <div id="loading" class="rounded-lg border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-700 hidden">正在加载模板...</div>
  <div id="emptyState" class="hidden rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6 text-center text-gray-600">
    暂无模板，请创建一个新模板。
  </div>

  <div class="flex items-center gap-3">
    <label class="text-sm text-gray-700 font-medium">类型筛选：</label>
    <select id="typeFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      <option value="all">全部</option>
      <option value="metrics_comparison">Metrics 对比模板</option>
      <option value="metrics_analysis">Metrics 分析模板</option>
    </select>
  </div>

  <div id="templatesList" class="hidden bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="w-1/4 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">模板名称</th>
          <th class="w-24 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
          <th class="w-2/5 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
          <th class="w-40 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
        </tr>
      </thead>
      <tbody id="templatesTableBody" class="bg-white divide-y divide-gray-200">
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let templates = [];
let selectedTemplate = null;

async function loadTemplates() {
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('emptyState').classList.add('hidden');
  document.getElementById('templatesList').classList.add('hidden');
  try {
    const [compRes, metricsRes] = await Promise.all([
      fetch('/api/templates?template_type=metrics_comparison'),
      fetch('/api/metrics-analysis/templates')
    ]);
    if (!compRes.ok) throw new Error('加载对比模板失败');
    if (!metricsRes.ok) throw new Error('加载 Metrics 模板失败');
    const comp = await compRes.json();
    const metrics = await metricsRes.json();
    const normalizedMetrics = metrics.map(m => ({
      template_id: m.template_id,
      name: m.name,
      description: m.description,
      created_at: m.created_at,
      template_type: m.template_type,
      anchor_source_dir: m.source_dir,
      anchor_bitstream_dir: m.bitstream_dir,
      test_source_dir: null,
      test_bitstream_dir: null,
      anchor_computed: false,
    }));
    templates = [...comp, ...normalizedMetrics];
    document.getElementById('loading').classList.add('hidden');
    if (!templates.length) {
      document.getElementById('emptyState').classList.remove('hidden');
      return;
    }
    renderTemplates();
  } catch (err) {
    document.getElementById('loading').classList.add('hidden');
    showToast(err.message || '加载模板失败', 'error');
  }
}

function renderTemplates() {
  const tbody = document.getElementById('templatesTableBody');
  const list = document.getElementById('templatesList');
  tbody.innerHTML = '';
  list.classList.remove('hidden');
  const filter = document.getElementById('typeFilter').value;
  const filtered = templates.filter(t => filter === 'all' || t.template_type === filter);
  filtered.forEach(tpl => {
    const row = document.createElement('tr');
    row.className = 'template-row hover:bg-gray-100 cursor-pointer transition-colors';
    row.dataset.templateId = tpl.template_id;
    row.dataset.templateType = tpl.template_type;

    const typeLabel = tpl.template_type === 'metrics_analysis'
      ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-700">Analysis</span>'
      : '<span class="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">Comparison</span>';

    row.innerHTML = `
      <td class="px-4 py-3 w-1/4">
        <div class="text-sm font-semibold text-gray-900">${escapeHtml(tpl.name || tpl.template_id)}</div>
        <div class="text-xs text-gray-500 mt-0.5">ID: ${tpl.template_id}</div>
      </td>
      <td class="px-4 py-3 w-24">
        ${typeLabel}
      </td>
      <td class="px-4 py-3 w-2/5">
        <div class="text-sm text-gray-600">${escapeHtml(tpl.description || '无描述')}</div>
      </td>
      <td class="px-4 py-3 w-40">
        <div class="text-sm text-gray-500">${tpl.created_at ? tpl.created_at.replace('T',' ').split('.')[0] : ''}</div>
      </td>
    `;

    row.addEventListener('click', () => selectTemplate(tpl));
    row.addEventListener('dblclick', () => {
      window.location.href = `/templates/${tpl.template_id}`;
    });

    tbody.appendChild(row);
  });
  updateActionButtons();
}

function selectTemplate(tpl) {
  selectedTemplate = tpl;
  document.querySelectorAll('.template-row').forEach(row => {
    if (row.dataset.templateId === tpl.template_id) {
      row.classList.add('selected');
    } else {
      row.classList.remove('selected');
    }
  });
  updateActionButtons();
}

function updateActionButtons() {
  const hasSelection = selectedTemplate !== null;
  document.getElementById('viewBtn').disabled = !hasSelection;
  document.getElementById('editBtn').disabled = !hasSelection;
  document.getElementById('deleteBtn').disabled = !hasSelection;
  document.getElementById('copyBtn').disabled = !hasSelection;
  const executeBtn = document.getElementById('executeBtn');
  executeBtn.disabled = !hasSelection;
  executeBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>创建任务';
}

// 绑定顶部操作按钮
document.getElementById('viewBtn').addEventListener('click', () => {
  if (selectedTemplate) {
    window.location.href = `/templates/${selectedTemplate.template_id}`;
  }
});

document.getElementById('editBtn').addEventListener('click', () => {
  if (selectedTemplate) {
    const url = `/templates/${selectedTemplate.template_id}/edit${selectedTemplate.template_type === 'metrics_analysis' ? '?type=metrics' : ''}`;
    window.location.href = url;
  }
});

document.getElementById('deleteBtn').addEventListener('click', (e) => {
  if (selectedTemplate) {
    showDeleteConfirm(e, {
      title: '确认删除该模板？',
      message: '此操作无法撤销。',
      onConfirm: () => deleteTemplate(selectedTemplate.template_id, selectedTemplate.template_type)
    });
  }
});

document.getElementById('copyBtn').addEventListener('click', async () => {
  if (selectedTemplate) {
    const btn = document.getElementById('copyBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>复制中...';
    try {
      const url = selectedTemplate.template_type === 'metrics_analysis'
        ? `/api/metrics-analysis/templates/${selectedTemplate.template_id}/copy`
        : `/api/templates/${selectedTemplate.template_id}/copy`;
      const res = await fetch(url, { method: 'POST' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || '复制失败');
      showToast('复制成功', 'success');

      // 保存新复制的模板ID
      const newTemplateId = data.template_id;

      // 重新加载模板
      await loadTemplates();

      // 自动选中新复制的模板
      if (newTemplateId) {
        const newTemplate = templates.find(t => t.template_id === newTemplateId);
        if (newTemplate) {
          selectTemplate(newTemplate);
          // 滚动到新模板卡片
          setTimeout(() => {
            const newCard = document.querySelector(`[data-template-id="${newTemplateId}"]`);
            if (newCard) {
              newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 100);
        }
      }

      // 恢复按钮状态
      btn.disabled = false;
      btn.innerHTML = originalText;
    } catch (err) {
      showToast(err.message || '复制失败', 'error');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }
});

document.getElementById('executeBtn').addEventListener('click', async () => {
  if (selectedTemplate) {
    const btn = document.getElementById('executeBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>创建中...';
    try {
      const url = selectedTemplate.template_type === 'metrics_analysis'
        ? `/api/metrics-analysis/templates/${selectedTemplate.template_id}/execute`
        : `/api/templates/${selectedTemplate.template_id}/execute`;
      const res = await fetch(url, { method: 'POST' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || '创建任务失败');
      showToast('任务已创建，正在跳转...', 'success');
      setTimeout(() => {
        window.location.href = '/jobs';
      }, 800);
    } catch (err) {
      showToast(err.message || '创建任务失败', 'error');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }
});

async function deleteTemplate(id, t) {
  try {
    const url = t === 'metrics_analysis' ? `/api/metrics-analysis/templates/${id}` : `/api/templates/${id}`;
    const res = await fetch(url, { method: 'DELETE' });
    if (!res.ok) throw new Error('删除失败');
    showToast('删除成功', 'success');
    selectedTemplate = null;
    loadTemplates();
  } catch (err) {
    showToast(err.message || '删除失败', 'error');
  }
}

const typeFilter = document.getElementById('typeFilter');
typeFilter.addEventListener('change', renderTemplates);
const params = new URLSearchParams(window.location.search);
const initType = params.get('type') === 'metrics' ? 'metrics_analysis' : 'all';
typeFilter.value = initType;

loadTemplates();
</script>

<style>
  /* 选中状态的深色主题样式 */
  .theme-dark .template-row.selected {
    background-color: rgba(59, 130, 246, 0.2) !important; /* 半透明蓝色 */
    border-left: 4px solid #3b82f6 !important; /* 蓝色边框 */
  }
</style>
{% endblock %}
