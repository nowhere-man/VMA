{% extends "base.html" %}

{% block title %}{{ '编辑模板' if template_id else '创建模板' }} - VMA{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
  <div class="bg-white rounded-lg shadow-sm p-6">
    <h1 class="text-2xl font-bold text-gray-900">{{ '编辑模板' if template_id else '创建模板' }}</h1>
    <p class="mt-1 text-sm text-gray-600">配置Metrics分析或对比模板。</p>
  </div>

<form id="templateForm" class="bg-white rounded-lg shadow-sm p-6 space-y-6">
    <!-- 基本信息 -->
    <div class="space-y-4">
      <h2 class="text-lg font-semibold text-gray-900">基本信息</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">模板类型<span class="text-red-500">*</span></label>
          <select id="template_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
            <option value="metrics_analysis">Metrics分析</option>
            <option value="metrics_comparison" selected>Metrics对比</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">模板名称<span class="text-red-500">*</span></label>
        <input id="name" name="name" required maxlength="100" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
        <input id="description" name="description" maxlength="500" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
      </div>
    </div>

    <!-- 公共源视频目录（仅 Metrics对比 模式显示） -->
    <div id="common_source_section" class="space-y-4 border-t pt-6">
      <h2 class="text-lg font-semibold text-gray-900">输入设置</h2>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">源视频目录<span class="text-red-500">*</span></label>
        <input id="common_source_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
        <p class="text-xs text-gray-500 mt-1">Anchor 和 Test 共用此源视频目录。YUV文件名格式需满足：stream_wxh_fps.yuv。</p>
      </div>
    </div>

    <!-- 输出设置（仅 Metrics对比 模式显示） -->
    <div id="output_settings_section" class="space-y-4 border-t pt-6">
      <h2 class="text-lg font-semibold text-gray-900">输出设置</h2>
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">短边尺寸</label>
          <input id="common_shortest_size" type="number" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="不填则使用源视频分辨率" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">目标帧率</label>
          <input id="common_target_fps" type="number" step="0.001" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="不填则使用源视频帧率" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Metrics 策略</label>
          <select id="common_upscale_to_source" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
            <option value="true" selected>转码流上采样到源流分辨率</option>
            <option value="false">源视频下采样到转码流分辨率</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">并发任务数</label>
          <input id="common_concurrency" type="number" min="1" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="默认为1" />
        </div>
      </div>
    </div>

    <!-- Anchor / 单侧 -->
    <div class="space-y-4 border-t pt-6">
      <div class="flex items-center justify-between">
        <h2 id="anchor_title" class="text-lg font-semibold text-gray-900">Anchor 基准项</h2>
        <label class="flex items-center text-sm text-gray-700 space-x-2">
          <input type="checkbox" id="anchor_skip" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
          <span>跳过视频编码</span>
        </label>
      </div>
      <!-- Metrics分析模式下的源视频目录 -->
      <div id="anchor_source_section" class="hidden">
        <label class="block text-sm font-medium text-gray-700 mb-1">源视频目录<span class="text-red-500">*</span></label>
        <input id="anchor_source_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
        <p class="text-xs text-gray-500 mt-1">YUV文件名格式需满足：stream_wxh_fps.yuv。</p>
      </div>
      <!-- 编码器配置（skip_encode 时隐藏） -->
      <div id="anchor_encoder_block" class="space-y-4">
        <!-- 第一行：编码器类型 + 编码器路径 -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器类型<span class="text-red-500">*</span></label>
            <select id="anchor_encoder_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="ffmpeg" selected>FFmpeg</option>
              <option value="x264">x264</option>
              <option value="x265">x265</option>
              <option value="vvenc">VVenC</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器路径</label>
            <input id="anchor_encoder_path" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="可选，留空则使用系统默认路径" />
          </div>
        </div>
        <!-- 第二行：编码参数 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">编码参数<span class="text-red-500">*</span></label>
          <input id="anchor_encoder_params" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
          <p id="anchor_params_hint" class="mt-1 text-xs text-gray-500"></p>
        </div>
      </div>
      <!-- 视频处理配置（仅 Metrics 分析模式显示） -->
      <div id="anchor_video_config" class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">短边尺寸</label>
          <input id="anchor_shortest_size" type="number" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="不填则使用源视频分辨率" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">目标帧率</label>
          <input id="anchor_target_fps" type="number" step="0.001" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="不填则使用源视频帧率" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Metrics 策略</label>
          <select id="anchor_upscale_to_source" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
            <option value="true" selected>转码流上采样到源流分辨率</option>
            <option value="false">源视频下采样到转码流分辨率</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">并发任务数</label>
          <input id="anchor_concurrency" type="number" min="1" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="默认为1" />
        </div>
      </div>
      <!-- RC + 码率点位（始终显示） -->
      <div id="anchor_rate_block" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">RC<span class="text-red-500">*</span></label>
            <select id="anchor_rate_control" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="crf" selected>CRF</option>
              <option value="abr">ABR</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">码率点位（逗号分隔，最少4个点位）<span class="text-red-500">*</span></label>
            <input id="anchor_bitrate_points" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="如：21,24,27,29" />
          </div>
        </div>
      </div>
      <!-- 码流目录（始终显示） -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">码流目录<span class="text-red-500">*</span></label>
        <input id="anchor_bitstream_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
      </div>
    </div>

    <!-- Test -->
    <div id="test_section" class="space-y-4 border-t pt-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Test 实验组</h2>
        <label class="flex items-center text-sm text-gray-700 space-x-2">
          <input type="checkbox" id="test_skip" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
          <span>跳过视频编码</span>
        </label>
      </div>
      <!-- 编码器配置（skip_encode 时隐藏） -->
      <div id="test_encoder_block" class="space-y-4">
        <!-- 第一行：编码器类型 + 编码器路径 -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器类型<span class="text-red-500">*</span></label>
            <select id="test_encoder_type" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="ffmpeg" selected>FFmpeg</option>
              <option value="x264">x264</option>
              <option value="x265">x265</option>
              <option value="vvenc">VVenC</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">编码器路径</label>
            <input id="test_encoder_path" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="可选，留空则使用系统默认路径" />
          </div>
        </div>
        <!-- 第二行：编码参数 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">编码参数<span class="text-red-500">*</span></label>
          <input id="test_encoder_params" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" />
          <p id="test_params_hint" class="mt-1 text-xs text-gray-500"></p>
        </div>
      </div>
      <!-- RC + 码率点位（始终显示） -->
      <div id="test_rate_block" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">RC<span class="text-red-500">*</span></label>
            <select id="test_rate_control" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500">
              <option value="">请选择</option>
              <option value="crf" selected>CRF</option>
              <option value="abr">ABR</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">码率点位（逗号分隔，最少4个点位）<span class="text-red-500">*</span></label>
            <input id="test_bitrate_points" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="如：21,24,27,29" />
          </div>
        </div>
      </div>
      <!-- 码流目录（始终显示） -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">码流目录<span class="text-red-500">*</span></label>
        <input id="test_bitstream_dir" class="w-full border px-3 py-2 rounded focus:ring-2 focus:ring-blue-500" required />
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between pt-4 border-t">
      <div id="formError" class="text-sm text-red-600"></div>
      <div class="space-x-3">
        <a href="/templates" class="text-sm text-gray-600 hover:text-gray-900">返回</a>
        {% if readonly %}
        <a href="/templates/{{ template_id }}/edit{% if request.query_params.get('type') == 'metrics' %}?type=metrics{% endif %}" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">编辑</a>
        {% else %}
        <button id="submitBtn" type="submit" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">保存模板</button>
        {% endif %}
      </div>
    </div>
  </form>
</div>

<script>
const tmplId = "{{ template_id or '' }}";
const READONLY = {{ 'true' if readonly else 'false' }};
const form = document.getElementById('templateForm');
const errBox = document.getElementById('formError');
const submitBtn = document.getElementById('submitBtn');
const urlParams = new URLSearchParams(window.location.search);
const initialType = urlParams.get('type') === 'metrics' ? 'metrics_analysis' : 'metrics_comparison';

function $(id) { return document.getElementById(id); }
const anchorSkip = $('anchor_skip');
const testSkip = $('test_skip');
const anchorEncoderBlock = $('anchor_encoder_block');
const testEncoderBlock = $('test_encoder_block');
const templateTypeSelect = $('template_type');
const testSection = $('test_section');
const anchorTitle = $('anchor_title');
const commonSourceSection = $('common_source_section');
const anchorSourceSection = $('anchor_source_section');
const commonSourceInput = $('common_source_dir');
const anchorSourceInput = $('anchor_source_dir');
const testBitstreamInput = $('test_bitstream_dir');
const anchorBitstreamInput = $('anchor_bitstream_dir');
const outputSettingsSection = $('output_settings_section');
const anchorVideoConfig = $('anchor_video_config');

function toggleRequired(el, required) {
  if (!el) return;
  if (required) {
    el.setAttribute('required', 'required');
  } else {
    el.removeAttribute('required');
  }
}

// 只隐藏编码器类型、路径、参数三项
function toggleEncoderBlocks() {
  anchorEncoderBlock.classList.toggle('hidden', anchorSkip.checked);
  testEncoderBlock.classList.toggle('hidden', testSkip.checked);
}
anchorSkip.addEventListener('change', toggleEncoderBlocks);
testSkip.addEventListener('change', toggleEncoderBlocks);
toggleEncoderBlocks();

function applyTypeUI(type) {
  if (type === 'metrics_analysis') {
    testSection.classList.add('hidden');
    anchorTitle.textContent = '输出配置';
    commonSourceSection.classList.add('hidden');
    anchorSourceSection.classList.remove('hidden');
    outputSettingsSection.classList.add('hidden');
    anchorVideoConfig.classList.remove('hidden');
    toggleRequired(commonSourceInput, false);
    toggleRequired(testBitstreamInput, false);
    toggleRequired(anchorSourceInput, true);
    toggleRequired(anchorBitstreamInput, true);
  } else {
    testSection.classList.remove('hidden');
    anchorTitle.textContent = 'Anchor 对照组';
    commonSourceSection.classList.remove('hidden');
    anchorSourceSection.classList.add('hidden');
    outputSettingsSection.classList.remove('hidden');
    anchorVideoConfig.classList.add('hidden');
    toggleRequired(commonSourceInput, true);
    toggleRequired(testBitstreamInput, true);
    toggleRequired(anchorSourceInput, false);
    toggleRequired(anchorBitstreamInput, true);
  }
}
templateTypeSelect.addEventListener('change', () => applyTypeUI(templateTypeSelect.value));
applyTypeUI(initialType);

function getEncoderParamsHint(encoderType) {
  const hints = {
    'ffmpeg': '示例: -c:v libx265 -preset fast --tune ssim -x265-params "bframes=3"',
    'x264': '示例: --preset fast --tune ssim --bframes 3',
    'x265': '示例: --preset fast --tune ssim --bframes 3',
    'vvenc': '示例: --preset fast --tune ssim --bframes 3'
  };
  return hints[encoderType] || '';
}

function updateParamsHint(prefix) {
  const encoderType = $(prefix + '_encoder_type').value;
  const hintEl = $(prefix + '_params_hint');
  if (hintEl) {
    hintEl.textContent = getEncoderParamsHint(encoderType);
  }
}

$('anchor_encoder_type').addEventListener('change', () => updateParamsHint('anchor'));
$('test_encoder_type').addEventListener('change', () => updateParamsHint('test'));
updateParamsHint('anchor');
updateParamsHint('test');

function parsePoints(val) {
  if (!val) return [];
  return val.split(',').map(s => s.trim()).filter(Boolean).map(Number).filter(v => !Number.isNaN(v));
}

function collectSide(prefix) {
  const type = templateTypeSelect.value;
  let sourceDir = '';
  if (type === 'metrics_analysis') {
    sourceDir = $(prefix + '_source_dir')?.value.trim() || '';
  } else {
    sourceDir = $('common_source_dir')?.value.trim() || '';
  }

  // 对于 Metrics 对比模式，使用公共输出设置
  let shortestSize, targetFps, upscaleToSource, concurrency;
  if (type === 'metrics_comparison') {
    shortestSize = $('common_shortest_size').value ? parseInt($('common_shortest_size').value) : null;
    targetFps = $('common_target_fps').value ? parseFloat($('common_target_fps').value) : null;
    upscaleToSource = $('common_upscale_to_source').value === 'true';
    concurrency = $('common_concurrency').value ? parseInt($('common_concurrency').value) : 1;
  } else {
    shortestSize = $(prefix + '_shortest_size').value ? parseInt($(prefix + '_shortest_size').value) : null;
    targetFps = $(prefix + '_target_fps').value ? parseFloat($(prefix + '_target_fps').value) : null;
    upscaleToSource = $(prefix + '_upscale_to_source').value === 'true';
    concurrency = $(prefix + '_concurrency').value ? parseInt($(prefix + '_concurrency').value) : 1;
  }

  return {
    skip_encode: $(prefix + '_skip').checked,
    source_dir: sourceDir,
    encoder_type: $(prefix + '_encoder_type').value || null,
    encoder_path: $(prefix + '_encoder_path')?.value.trim() || null,
    encoder_params: $(prefix + '_encoder_params').value.trim() || null,
    rate_control: $(prefix + '_rate_control').value || null,
    bitrate_points: parsePoints($(prefix + '_bitrate_points').value),
    bitstream_dir: $(prefix + '_bitstream_dir').value.trim(),
    shortest_size: shortestSize,
    target_fps: targetFps,
    upscale_to_source: upscaleToSource,
    concurrency: concurrency,
  };
}

async function loadTemplate() {
  if (!tmplId) return;
  try {
    let res = await fetch(`/api/templates/${tmplId}`);
    let data;
    if (res.ok) {
      data = await res.json();
    } else {
      const metricsRes = await fetch(`/api/metrics-analysis/templates/${tmplId}`);
      if (!metricsRes.ok) throw new Error('加载模板失败');
      data = await metricsRes.json();
      data.template_type = 'metrics_analysis';
      data.anchor = data.config;
      data.test = null;
    }
    templateTypeSelect.value = data.template_type || 'metrics_comparison';
    applyTypeUI(templateTypeSelect.value);
    $('name').value = data.name || '';
    $('description').value = data.description || '';
    const fill = (prefix, side) => {
      if (!side) return;
      const setValue = (suffix, value) => {
        const el = $(prefix + '_' + suffix);
        if (el) el.value = value ?? '';
      };
      setValue('source_dir', side.source_dir || '');
      setValue('bitstream_dir', side.bitstream_dir || '');
      const skipEl = $(prefix + '_skip');
      if (skipEl) skipEl.checked = !!side.skip_encode;
      setValue('encoder_type', side.encoder_type || '');
      setValue('encoder_path', side.encoder_path || '');
      setValue('encoder_params', side.encoder_params || '');
      setValue('rate_control', side.rate_control || '');
      setValue('bitrate_points', (side.bitrate_points || []).join(','));
      setValue('shortest_size', side.shortest_size || '');
      setValue('target_fps', side.target_fps || '');
      setValue('upscale_to_source', side.upscale_to_source !== false ? 'true' : 'false');
      setValue('concurrency', side.concurrency || '');
    };
    fill('anchor', data.anchor);
    fill('test', data.test);
    // 对比模式下，填充公共源视频目录和输出设置
    if (data.template_type === 'metrics_comparison') {
      if (data.anchor?.source_dir) {
        $('common_source_dir').value = data.anchor.source_dir || '';
      }
      // 填充公共输出设置（从 anchor 获取）
      if (data.anchor) {
        $('common_shortest_size').value = data.anchor.shortest_size || '';
        $('common_target_fps').value = data.anchor.target_fps || '';
        $('common_upscale_to_source').value = data.anchor.upscale_to_source !== false ? 'true' : 'false';
        $('common_concurrency').value = data.anchor.concurrency || '';
      }
    }
    toggleEncoderBlocks();
    if (READONLY) setReadonlyMode();
  } catch (e) {
    errBox.textContent = e.message || '加载模板失败';
  }
}

function setReadonlyMode() {
  if (!READONLY) return;
  const inputs = form.querySelectorAll('input, select, textarea, button');
  inputs.forEach(el => {
    // 保留顶部导航的"返回/编辑"按钮
    if (el.id === 'submitBtn') {
      el.style.display = 'none';
      return;
    }
    if (el.closest('a')) return;
    el.disabled = true;
  });
}
// 初始化类型选择
templateTypeSelect.value = initialType;
applyTypeUI(initialType);
loadTemplate();

form.addEventListener('submit', async (e) => {
  if (READONLY) {
    e.preventDefault();
    return;
  }
  e.preventDefault();
  errBox.textContent = '';
  submitBtn.disabled = true;
  const payload = {
    name: $('name').value.trim(),
    description: $('description').value.trim() || null,
    anchor: collectSide('anchor'),
    test: collectSide('test'),
  };
  const type = templateTypeSelect.value;
  const method = tmplId ? 'PUT' : 'POST';
  let url;
  if (type === 'metrics_analysis') {
    url = tmplId ? `/api/metrics-analysis/templates/${tmplId}` : '/api/metrics-analysis/templates';
    payload.config = payload.anchor;
    delete payload.anchor;
    delete payload.test;
  } else {
    url = tmplId ? `/api/templates/${tmplId}` : '/api/templates';
  }
  try {
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.detail || '保存失败');
    window.location.href = '/templates';
  } catch (err) {
    errBox.textContent = err.message || '保存失败';
  } finally {
    submitBtn.disabled = false;
  }
});
</script>
{% endblock %}
