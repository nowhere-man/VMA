{% extends "base.html" %}

{% block title %}Schedule ç®¡ç† - VMA{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="bg-white rounded-lg shadow-sm p-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">ğŸ“… å®šæ—¶ä»»åŠ¡</h1>
        <p class="mt-1 text-sm text-gray-600">å®šæ—¶æ‰§è¡Œæ¨¡æ¿ä»»åŠ¡ï¼Œè‡ªåŠ¨ç¼–è¯‘ç¼–ç å™¨</p>
      </div>
      <a href="/schedules/new" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
        åˆ›å»º Schedule
      </a>
    </div>
  </div>

  <!-- Schedule åˆ—è¡¨ -->
  <div class="bg-white rounded-lg shadow-sm">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç§°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¼–ç å™¨</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¨¡æ¿</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡å¤å‘¨æœŸ</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸‹æ¬¡æ‰§è¡Œ</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€è¿‘æ‰§è¡Œ</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="scheduleTableBody">
          <!-- åŠ¨æ€åŠ è½½ -->
        </tbody>
      </table>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="emptyState" class="hidden p-12 text-center">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">æš‚æ—  Schedule</h3>
      <p class="mt-1 text-sm text-gray-500">åˆ›å»ºç¬¬ä¸€ä¸ªå®šæ—¶ä»»åŠ¡</p>
      <div class="mt-6">
        <a href="/schedules/new" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
          åˆ›å»º Schedule
        </a>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loadingState" class="p-12 text-center">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <p class="mt-2 text-sm text-gray-600">åŠ è½½ä¸­...</p>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  await loadSchedules();
});

async function loadSchedules() {
  const loadingState = document.getElementById('loadingState');
  const emptyState = document.getElementById('emptyState');
  const tableBody = document.getElementById('scheduleTableBody');

  try {
    loadingState.classList.remove('hidden');

    const res = await fetch('/api/schedules');
    if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');

    const schedules = await res.json();

    loadingState.classList.add('hidden');

    if (schedules.length === 0) {
      emptyState.classList.remove('hidden');
      return;
    }

    tableBody.innerHTML = schedules.map(schedule => {
      const statusBadge = getStatusBadge(schedule.status);
      const repeatLabel = getRepeatLabel(schedule.repeat);

      return `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${escapeHtml(schedule.name)}</div>
            ${schedule.description ? `<div class="text-sm text-gray-500">${escapeHtml(schedule.description)}</div>` : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${escapeHtml(schedule.encoder_type)}</div>
            <div class="text-xs text-gray-500">${escapeHtml(schedule.encoder_config.branch)}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${escapeHtml(schedule.template_name)}</div>
            <div class="text-xs text-gray-500">${schedule.template_type === 'metrics_analysis' ? 'Metrics åˆ†æ' : 'Metrics å¯¹æ¯”'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${repeatLabel}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${statusBadge}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${schedule.next_execution ? formatDateTime(schedule.next_execution) : '-'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${schedule.last_execution ? formatDateTime(schedule.last_execution) : '-'}
            ${schedule.last_execution_status ? (schedule.last_execution_status === 'success' ?
              '<span class="ml-1 text-green-600">âœ“</span>' :
              '<span class="ml-1 text-red-600">âœ—</span>') : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex items-center justify-end space-x-2">
              <a href="/schedules/${schedule.schedule_id}" class="text-blue-600 hover:text-blue-900">æŸ¥çœ‹</a>
              ${schedule.status === 'active' ?
                `<button onclick="pauseSchedule('${schedule.schedule_id}')" class="text-orange-600 hover:text-orange-900">æš‚åœ</button>` :
                `<button onclick="resumeSchedule('${schedule.schedule_id}')" class="text-green-600 hover:text-green-900">æ¢å¤</button>`
              }
              <button onclick="triggerSchedule('${schedule.schedule_id}')" class="text-purple-600 hover:text-purple-900">æ‰§è¡Œ</button>
              <a href="/schedules/${schedule.schedule_id}/edit" class="text-gray-600 hover:text-gray-900">ç¼–è¾‘</a>
              <button onclick="copySchedule('${schedule.schedule_id}')" class="text-gray-600 hover:text-gray-900">å¤åˆ¶</button>
              <button onclick="deleteSchedule('${schedule.schedule_id}')" class="text-red-600 hover:text-red-900">åˆ é™¤</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

  } catch (error) {
    loadingState.classList.add('hidden');
    alert(error.message || 'åŠ è½½å¤±è´¥');
  }
}

function getStatusBadge(status) {
  const styles = {
    active: 'bg-green-100 text-green-800',
    paused: 'bg-orange-100 text-orange-800',
    disabled: 'bg-gray-100 text-gray-800',
  };
  const labels = {
    active: 'è¿è¡Œä¸­',
    paused: 'å·²æš‚åœ',
    disabled: 'å·²ç¦ç”¨',
  };
  return `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${styles[status] || styles.disabled}">${labels[status] || status}</span>`;
}

function getRepeatLabel(repeat) {
  const labels = {
    none: 'ä¸é‡å¤',
    daily: 'æ¯å¤©',
    weekly: 'æ¯å‘¨',
    monthly: 'æ¯æœˆ',
  };
  return labels[repeat] || repeat;
}

async function pauseSchedule(scheduleId) {
  if (!confirm('ç¡®å®šè¦æš‚åœæ­¤ Schedule å—ï¼Ÿ')) return;

  try {
    const res = await fetch(`/api/schedules/${scheduleId}/pause`, { method: 'POST' });
    if (!res.ok) throw new Error('æš‚åœå¤±è´¥');
    await loadSchedules();
  } catch (error) {
    alert(error.message || 'æš‚åœå¤±è´¥');
  }
}

async function resumeSchedule(scheduleId) {
  if (!confirm('ç¡®å®šè¦æ¢å¤æ­¤ Schedule å—ï¼Ÿ')) return;

  try {
    const res = await fetch(`/api/schedules/${scheduleId}/resume`, { method: 'POST' });
    if (!res.ok) throw new Error('æ¢å¤å¤±è´¥');
    await loadSchedules();
  } catch (error) {
    alert(error.message || 'æ¢å¤å¤±è´¥');
  }
}

async function triggerSchedule(scheduleId) {
  if (!confirm('ç¡®å®šè¦ç«‹å³æ‰§è¡Œæ­¤ Schedule å—ï¼Ÿ')) return;

  try {
    const res = await fetch(`/api/schedules/${scheduleId}/trigger`, { method: 'POST' });
    if (!res.ok) throw new Error('æ‰§è¡Œå¤±è´¥');
    alert('å·²è§¦å‘æ‰§è¡Œï¼Œè¯·ç¨åæŸ¥çœ‹æ‰§è¡Œå†å²');
    await loadSchedules();
  } catch (error) {
    alert(error.message || 'æ‰§è¡Œå¤±è´¥');
  }
}

async function copySchedule(scheduleId) {
  if (!confirm('ç¡®å®šè¦å¤åˆ¶æ­¤ Schedule å—ï¼Ÿ')) return;

  try {
    const res = await fetch(`/api/schedules/${scheduleId}/copy`, { method: 'POST' });
    if (!res.ok) throw new Error('å¤åˆ¶å¤±è´¥');
    await loadSchedules();
  } catch (error) {
    alert(error.message || 'å¤åˆ¶å¤±è´¥');
  }
}

async function deleteSchedule(scheduleId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ Schedule å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

  try {
    const res = await fetch(`/api/schedules/${scheduleId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
    await loadSchedules();
  } catch (error) {
    alert(error.message || 'åˆ é™¤å¤±è´¥');
  }
}

function formatDateTime(isoString) {
  const date = new Date(isoString);
  const pad = (n) => String(n).padStart(2, '0');
  return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
{% endblock %}
